---
import { LANDMARKS } from '../lib/landmarks';

interface Props {
  lang?: string;
}

const { lang: propLang } = Astro.props;
const lang = propLang || Astro.url.searchParams.get('lang') || 'ko';

const labels: Record<string, Record<string, string>> = {
  ko: { title: '내 주변 문화유산', find: '내 위치 찾기', finding: '위치 확인 중...', nearbyCount: '개 발견', km: 'km', m: 'm', away: '떨어짐', noResults: '주변에 문화유산이 없습니다', expandRadius: '반경을 넓혀보세요', palace: '궁궐', treasure: '보물', historic: '사적', scenic: '명승', farAway: '해외에 계시네요!', nearest: '가장 가까운 문화유산', goToSeoul: '서울 궁궐 보기', detail: '자세히 보기', radius: '반경' },
  en: { title: 'Heritage Near Me', find: 'Find My Location', finding: 'Locating...', nearbyCount: ' found', km: 'km', m: 'm', away: 'away', noResults: 'No heritage sites nearby', expandRadius: 'Try expanding the radius', palace: 'Palace', treasure: 'Treasure', historic: 'Historic', scenic: 'Scenic', farAway: "You're outside Korea!", nearest: 'Nearest heritage site', goToSeoul: 'View Seoul Palaces', detail: 'View Details', radius: 'Radius' },
  ja: { title: '周辺の文化遺産', find: '現在地を探す', finding: '位置確認中...', nearbyCount: '件発見', km: 'km', m: 'm', away: '離れ', noResults: '周辺に文化遺産がありません', expandRadius: '範囲を広げてみてください', palace: '宮殿', treasure: '宝物', historic: '史跡', scenic: '名勝', farAway: '海外にいらっしゃいますね！', nearest: '最寄りの文化遺産', goToSeoul: 'ソウルの宮殿を見る', detail: '詳細を見る', radius: '半径' },
  zh: { title: '我附近的文化遗产', find: '查找我的位置', finding: '定位中...', nearbyCount: '个发现', km: 'km', m: 'm', away: '距离', noResults: '附近没有文化遗产', expandRadius: '请尝试扩大范围', palace: '宫殿', treasure: '宝物', historic: '史迹', scenic: '名胜', farAway: '您在韩国境外！', nearest: '最近的文化遗产', goToSeoul: '查看首尔宫殿', detail: '查看详情', radius: '半径' },
  kr: { title: '내 주변 문화유산', find: '내 위치 찾기', finding: '위치 확인 중...', nearbyCount: '개 발견', km: 'km', m: 'm', away: '떨어짐', noResults: '주변에 문화유산이 없습니다', expandRadius: '반경을 넓혀보세요', palace: '궁궐', treasure: '보물', historic: '사적', scenic: '명승', farAway: '해외에 계시네요!', nearest: '가장 가까운 문화유산', goToSeoul: '서울 궁궐 보기', detail: '자세히 보기', radius: '반경' },
};

const L = labels[lang] || labels['ko'];

/* landmarks → map에서 쓸 수 있는 flat 구조로 변환 */
const mapLandmarks = LANDMARKS.map(lm => ({
  id: lm.id,
  type: lm.type,
  lat: lm.lat,
  lng: lm.lng,
  image: lm.image,
  link: lm.link,
  name_ko: lm.nameKr,
  name_en: lm.nameEn,
  name_ja: lm.nameJa,
  name_zh: lm.nameZh,
  desc_ko: lm.descKr,
  desc_en: lm.descEn,
  desc_ja: lm.descJa || lm.descKr,
  desc_zh: lm.descZh || lm.descKr,
}));

const landmarkData = JSON.stringify(mapLandmarks);
---

<section class="map-section" id="map-section">
  <div class="map-header">
    <h2>{L.title}</h2>
    <button class="locate-btn" id="locateBtn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg>
      {L.find}
    </button>
  </div>

  <!-- Far away banner -->
  <div class="far-banner" id="farBanner" style="display:none;">
    <span class="far-text" id="farText"></span>
    <button class="go-seoul-btn" id="goSeoulBtn">{L.goToSeoul}</button>
  </div>

  <!-- Radius controls -->
  <div class="radius-controls" id="radiusControls" style="display:none;">
    <span>{L.radius}:</span>
    <button class="radius-btn" data-r="1">1km</button>
    <button class="radius-btn active" data-r="3">3km</button>
    <button class="radius-btn" data-r="5">5km</button>
    <button class="radius-btn" data-r="10">10km</button>
  </div>

  <div class="map-wrap">
    <div id="map"></div>

    <!-- ★ 지도 위 플로팅 내 위치 버튼 -->
    <button class="map-fab" id="mapLocateFab" aria-label="내 위치로 이동" title="내 위치로 이동">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 2v4m0 12v4M2 12h4m12 0h4"/>
      </svg>
    </button>

    <!-- Bottom sheet for marker detail -->
    <div class="bottom-sheet" id="bottomSheet">
      <div class="sheet-handle"></div>
      <div class="sheet-content" id="sheetContent"></div>
    </div>
  </div>

  <!-- Nearby list -->
  <div class="nearby-list" id="nearbyList" style="display:none;"></div>
</section>

<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />

<style>
  .map-section {
    padding: 0;
    background: var(--color-bg, #FAF6F1);
  }
  .map-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 20px 14px;
  }
  .map-header h2 {
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0;
    color: var(--color-text, #1A1210);
  }
  .locate-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border: none;
    border-radius: 20px;
    background: var(--accent, var(--color-primary, #C8956C));
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
  }
  .locate-btn svg { flex-shrink: 0; }
  .locate-btn:disabled { opacity: 0.6; cursor: not-allowed; }

  .far-banner {
    margin: 0 20px 10px;
    padding: 12px 16px;
    background: var(--bg-secondary, var(--color-card, #FFFFFF));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
  }
  .far-text { font-size: 0.85rem; color: var(--text-secondary, var(--color-text-light, #6B5B4F)); }
  .go-seoul-btn {
    padding: 6px 14px;
    border: none;
    border-radius: 8px;
    background: var(--accent, var(--color-primary, #C8956C));
    color: #fff;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
  }

  .radius-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 20px 10px;
    font-size: 0.85rem;
    color: var(--text-secondary, var(--color-text-light, #6B5B4F));
  }
  .radius-btn {
    padding: 4px 12px;
    border: 1px solid var(--border, var(--color-border, #E8DDD4));
    border-radius: 16px;
    background: transparent;
    color: var(--text-secondary, var(--color-text-light, #6B5B4F));
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .radius-btn.active {
    background: var(--accent, var(--color-primary, #C8956C));
    color: #fff;
    border-color: var(--accent, var(--color-primary, #C8956C));
  }

  .map-wrap {
    position: relative;
    margin: 0 20px;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  }
  #map {
    width: 100%;
    height: 420px;
  }
  @media (max-width: 640px) {
    #map { height: 350px; }
  }

  /* ★ 플로팅 내 위치 버튼 (지도 위) */
  .map-fab {
    position: absolute;
    bottom: 80px;
    right: 12px;
    z-index: 10;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: #fff;
    color: #333;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .map-fab:hover {
    background: #f0f0f0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transform: scale(1.05);
  }
  .map-fab:active {
    transform: scale(0.95);
  }
  .map-fab.locating {
    animation: fab-pulse 1s ease-in-out infinite;
  }
  .map-fab.located {
    background: var(--accent, var(--color-primary, #C8956C));
    color: #fff;
  }
  @keyframes fab-pulse {
    0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    50% { box-shadow: 0 2px 16px rgba(66,133,244,0.5); }
  }

  html.dark .map-fab {
    background: #2D2720;
    color: #F0E6DC;
  }
  html.dark .map-fab:hover { background: #3D3530; }
  html.dark .map-fab.located {
    background: var(--accent, var(--color-primary, #D4A574));
    color: #fff;
  }

  /* Bottom sheet */
  .bottom-sheet {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    background: var(--bg-primary, var(--color-card, #fff));
    border-radius: 16px 16px 0 0;
    padding: 0 16px 16px;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 20;
    max-height: 50%;
    overflow-y: auto;
  }
  html.dark .bottom-sheet {
    background: var(--color-card, #1C1916);
  }
  .bottom-sheet.open { transform: translateY(0); }
  .sheet-handle {
    width: 36px; height: 4px;
    background: var(--border, var(--color-border, #E8DDD4));
    border-radius: 2px;
    margin: 10px auto 12px;
  }
  .sheet-row { display: flex; gap: 12px; align-items: flex-start; }
  .sheet-img {
    width: 80px; height: 60px;
    object-fit: cover;
    border-radius: 10px;
    flex-shrink: 0;
    background: var(--border, var(--color-border, #E8DDD4));
  }
  .sheet-info { flex: 1; min-width: 0; }
  .sheet-type {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 6px;
  }
  .sheet-name {
    font-size: 1rem;
    font-weight: 700;
    margin-top: 4px;
    color: var(--color-text, #1A1210);
  }
  .sheet-desc {
    font-size: 0.8rem;
    color: var(--text-muted, var(--color-text-muted, #9A8B7F));
    margin-top: 4px;
    line-height: 1.4;
  }
  .sheet-link {
    display: inline-block;
    margin-top: 10px;
    padding: 8px 20px;
    background: var(--accent, var(--color-primary, #C8956C));
    color: #fff;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 600;
    text-decoration: none;
  }

  /* Custom Marker */
  .marker-icon {
    cursor: pointer;
    display: block;
  }
  .marker-icon * { pointer-events: none; }

  /* Nearby horizontal list */
  .nearby-list {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
  }
  .nearby-list::-webkit-scrollbar { display: none; }
  .nearby-card {
    flex-shrink: 0;
    width: 160px;
    scroll-snap-align: start;
    background: var(--bg-secondary, var(--color-card, #FFFFFF));
    border-radius: 12px;
    overflow: hidden;
    text-decoration: none;
    color: inherit;
  }
  .nearby-card img {
    width: 100%; height: 90px;
    object-fit: cover;
    background: var(--border, var(--color-border, #E8DDD4));
  }
  .nearby-card .card-body { padding: 8px 10px 10px; }
  .nearby-card .card-name {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--color-text, #1A1210);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .nearby-card .card-dist {
    font-size: 0.7rem;
    color: var(--text-muted, var(--color-text-muted, #9A8B7F));
    margin-top: 2px;
  }

  :global(.maplibregl-popup) { display: none !important; }
</style>

<script define:vars={{ landmarkData, lang, labelsAll: labels }}>
(function() {
  const LANDMARKS = JSON.parse(landmarkData);
  const L = labelsAll[lang] || labelsAll['ko'];
  const SEOUL = { lat: 37.5796, lng: 126.977 };

  const typeColors = {
    palace: '#B8860B',
    treasure: '#C0392B',
    historic: '#2E86C1',
    scenic: '#27AE60'
  };

  const typeLabels = {
    palace: L.palace,
    treasure: L.treasure,
    historic: L.historic,
    scenic: L.scenic
  };

  /* ===== SVG Markers ===== */
  function createPalaceMarkerSVG(type) {
    const color = typeColors[type] || '#B8860B';
    /* 한국 팔작지붕 궁궐 마커 */
    return `
      <svg xmlns="http://www.w3.org/2000/svg" width="40" height="48" viewBox="0 0 40 48" fill="none">
        <!-- 그림자 -->
        <ellipse cx="20" cy="46" rx="6" ry="2" fill="rgba(0,0,0,0.15)"/>
        <!-- 핀 기둥 -->
        <path d="M20 44 L20 32" stroke="${color}" stroke-width="2.5" stroke-linecap="round"/>
        <!-- 배경 원 -->
        <circle cx="20" cy="17" r="16" fill="${color}" opacity="0.1"/>
        <!-- 팔작지붕 (완만한 곡선, 양끝 살짝 올림) -->
        <path d="M3 21 Q6 19 9 17 Q14 12 20 9 Q26 12 31 17 Q34 19 37 21 Q35 22 33 21.5 Q30 20 28 19 L27 23 L13 23 L12 19 Q10 20 7 21.5 Q5 22 3 21Z" fill="${color}"/>
        <!-- 용마루 (지붕 꼭대기 수평선) -->
        <line x1="13" y1="14" x2="27" y2="14" stroke="#fff" stroke-width="0.7" opacity="0.5"/>
        <!-- 처마 곡선 강조 -->
        <path d="M3 21 Q2 20.5 3.5 19.5" stroke="${color}" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <path d="M37 21 Q38 20.5 36.5 19.5" stroke="${color}" stroke-width="1.2" fill="none" stroke-linecap="round"/>
        <!-- 건물 몸체 -->
        <rect x="12" y="23" width="16" height="7" rx="0.5" fill="${color}" opacity="0.85"/>
        <!-- 기둥 3개 -->
        <line x1="16" y1="23" x2="16" y2="30" stroke="#fff" stroke-width="0.8" opacity="0.35"/>
        <line x1="20" y1="23" x2="20" y2="30" stroke="#fff" stroke-width="0.8" opacity="0.35"/>
        <line x1="24" y1="23" x2="24" y2="30" stroke="#fff" stroke-width="0.8" opacity="0.35"/>
        <!-- 문 (격자문양) -->
        <rect x="17.5" y="25" width="5" height="5" rx="0.3" fill="#fff" opacity="0.2"/>
        <line x1="20" y1="25" x2="20" y2="30" stroke="#fff" stroke-width="0.4" opacity="0.2"/>
        <line x1="17.5" y1="27.5" x2="22.5" y2="27.5" stroke="#fff" stroke-width="0.4" opacity="0.2"/>
        <!-- 잡상 (지붕 위 작은 장식) -->
        <circle cx="20" cy="9" r="1" fill="${color}" opacity="0.7"/>
      </svg>`;
  }

  function createHeritageMarkerSVG(type) {
    const color = typeColors[type] || '#2E86C1';
    let icon = '';
    if (type === 'treasure') {
      /* 보물 — 한국 범종 형태 */
      icon = `
        <path d="M14 11 C14 8 22 8 22 11 L23 19 C23 20.5 13 20.5 13 19 Z" fill="#fff" opacity="0.85"/>
        <ellipse cx="18" cy="20" rx="5.5" ry="1.2" fill="#fff" opacity="0.5"/>
        <circle cx="18" cy="14.5" r="1.5" fill="${color}" opacity="0.4"/>
        <rect x="16.5" y="7" width="3" height="2" rx="1" fill="#fff" opacity="0.7"/>
      `;
    } else if (type === 'historic') {
      /* 사적 — 한국 석탑 (다층 간결) */
      icon = `
        <rect x="14" y="21" width="8" height="2.5" rx="0.3" fill="#fff" opacity="0.85"/>
        <rect x="14.8" y="17.5" width="6.4" height="3.5" rx="0.3" fill="#fff" opacity="0.8"/>
        <rect x="15.6" y="14" width="4.8" height="3.5" rx="0.3" fill="#fff" opacity="0.75"/>
        <rect x="16.4" y="11" width="3.2" height="3" rx="0.3" fill="#fff" opacity="0.7"/>
        <path d="M17 11 L18 8.5 L19 11" fill="#fff" opacity="0.65"/>
        <line x1="18" y1="7" x2="18" y2="8.5" stroke="#fff" stroke-width="0.8" opacity="0.6"/>
      `;
    } else {
      /* 명승 — 산과 나무 */
      icon = `
        <path d="M9 23 L14 14 L17 17 L22 11 L27 23 Z" fill="#fff" opacity="0.75"/>
        <path d="M12 23 L16 16 L19 19 L24 13 L29 23 Z" fill="#fff" opacity="0.45"/>
        <circle cx="25" cy="11" r="2.5" fill="#fff" opacity="0.5"/>
      `;
    }
    return `
      <svg xmlns="http://www.w3.org/2000/svg" width="36" height="44" viewBox="0 0 36 44" fill="none">
        <ellipse cx="18" cy="42" rx="5" ry="2" fill="rgba(0,0,0,0.15)"/>
        <path d="M18 40 L18 30" stroke="${color}" stroke-width="2" stroke-linecap="round"/>
        <circle cx="18" cy="17" r="14" fill="${color}"/>
        <circle cx="18" cy="17" r="12.5" fill="none" stroke="#fff" stroke-width="0.5" opacity="0.2"/>
        ${icon}
      </svg>`;
  }

  function getMarkerSVG(type) {
    if (type === 'palace') return createPalaceMarkerSVG(type);
    return createHeritageMarkerSVG(type);
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function formatDist(km) {
    if (km < 1) return Math.round(km * 1000) + L.m;
    return km.toFixed(1) + L.km;
  }

  function pickLang(lm) {
    const key = lang === 'ko' || lang === 'kr' ? 'ko' : lang === 'en' ? 'en' : lang === 'ja' ? 'ja' : 'zh';
    return lm['name_' + key] || lm.name_ko;
  }

  function pickDesc(lm) {
    const key = lang === 'ko' || lang === 'kr' ? 'ko' : lang === 'en' ? 'en' : lang === 'ja' ? 'ja' : 'zh';
    return lm['desc_' + key] || lm.desc_ko || '';
  }

  /* ===== Init Map ===== */
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js';
  script.onload = initMap;
  document.head.appendChild(script);

  let map, markers = [], userMarker = null, userLat = null, userLng = null, currentRadius = 3;

  function initMap() {
    map = new maplibregl.Map({
      container: 'map',
      style: 'https://tiles.openfreemap.org/styles/liberty',
      center: [SEOUL.lng, SEOUL.lat],
      zoom: 12.5,
      pitch: 40,
      attributionControl: false
    });
    map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');
    map.on('load', () => { addMarkers(LANDMARKS); });
    map.on('click', (e) => {
      setTimeout(() => {
        if (!markerClicked) closeSheet();
        markerClicked = false;
      }, 50);
    });
  }

  let markerClicked = false;
  const bottomSheet = document.getElementById('bottomSheet');
  const sheetContent = document.getElementById('sheetContent');

  function closeSheet() { bottomSheet.classList.remove('open'); }

  function openSheet(lm) {
    const name = pickLang(lm);
    const desc = pickDesc(lm);
    const type = lm.type || 'palace';
    const color = typeColors[type] || '#B8860B';
    const tLabel = typeLabels[type] || type;
    const dist = (userLat != null) ? formatDist(haversine(userLat, userLng, lm.lat, lm.lng)) : '';
    const link = lm.link || '#';
    const imgSrc = lm.image || '';

    sheetContent.innerHTML = `
      <div class="sheet-row">
        ${imgSrc ? `<img class="sheet-img" src="${imgSrc}" alt="${name}" onerror="this.style.display='none'"/>` : ''}
        <div class="sheet-info">
          <span class="sheet-type" style="background:${color}22;color:${color}">${tLabel}</span>
          ${dist ? `<span style="font-size:0.7rem;color:var(--text-muted, var(--color-text-muted));margin-left:6px">${dist} ${L.away}</span>` : ''}
          <div class="sheet-name">${name}</div>
          <div class="sheet-desc">${desc}</div>
        </div>
      </div>
      ${link !== '#' ? `<a class="sheet-link" href="${link}?lang=${lang}">${L.detail}</a>` : ''}
    `;
    bottomSheet.classList.add('open');
  }

  function addMarkers(landmarks) {
    markers.forEach(m => m.remove());
    markers = [];
    landmarks.forEach(lm => {
      const type = lm.type || 'palace';
      const svgStr = getMarkerSVG(type);
      const el = document.createElement('div');
      el.className = 'marker-icon';
      el.innerHTML = svgStr;
      el.style.width = type === 'palace' ? '40px' : '36px';
      el.style.height = type === 'palace' ? '48px' : '44px';
      el.style.transition = 'none';
      el.style.transform = 'none';
      el.style.animation = 'none';
      el.style.willChange = 'auto';

      el.addEventListener('click', (e) => {
        e.stopPropagation();
        markerClicked = true;
        map.easeTo({ center: [lm.lng, lm.lat], offset: [0, -60], duration: 300 });
        openSheet(lm);
      });
      el.addEventListener('touchstart', (e) => { e.stopPropagation(); }, { passive: true });

      const marker = new maplibregl.Marker({ element: el, anchor: 'bottom', offset: [0, 0] })
        .setLngLat([lm.lng, lm.lat])
        .addTo(map);
      markers.push(marker);
    });
  }

  /* ===== Locate — 공통 함수 ===== */
  function doLocate() {
    const locateBtn = document.getElementById('locateBtn');
    const fab = document.getElementById('mapLocateFab');
    locateBtn.textContent = L.finding;
    locateBtn.disabled = true;
    fab.classList.add('locating');

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;

        /* 버튼 상태 복원 */
        locateBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg> ${L.find}`;
        locateBtn.disabled = false;
        fab.classList.remove('locating');
        fab.classList.add('located');

        /* 사용자 마커 */
        if (userMarker) userMarker.remove();
        const userEl = document.createElement('div');
        userEl.style.cssText = 'width:16px;height:16px;background:#4285F4;border:3px solid #fff;border-radius:50%;box-shadow:0 0 8px rgba(66,133,244,0.5);';
        userMarker = new maplibregl.Marker({ element: userEl })
          .setLngLat([userLng, userLat])
          .addTo(map);

        /* 서울로부터 거리 확인 */
        const distToSeoul = haversine(userLat, userLng, SEOUL.lat, SEOUL.lng);
        const farBanner = document.getElementById('farBanner');
        const farText = document.getElementById('farText');
        const radiusControls = document.getElementById('radiusControls');

        if (distToSeoul > 200) {
          /* 해외 사용자 */
          farBanner.style.display = 'flex';
          radiusControls.style.display = 'none';
          const nearest = [...LANDMARKS].sort((a, b) =>
            haversine(userLat, userLng, a.lat, a.lng) - haversine(userLat, userLng, b.lat, b.lng)
          )[0];
          const nd = formatDist(haversine(userLat, userLng, nearest.lat, nearest.lng));
          farText.textContent = `✈️ ${L.farAway} ${L.nearest}: ${pickLang(nearest)} — ${nd}`;
          map.flyTo({ center: [userLng, userLat], zoom: 5, duration: 1000 });
        } else {
          /* 한국 내 사용자 */
          farBanner.style.display = 'none';
          radiusControls.style.display = 'flex';
          map.flyTo({ center: [userLng, userLat], zoom: 14, duration: 1000 });
          updateNearby();
        }
      },
      (err) => {
        locateBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg> ${L.find}`;
        locateBtn.disabled = false;
        fab.classList.remove('locating');
        alert('Location access denied');
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  }

  /* ===== 버튼 이벤트 바인딩 ===== */
  document.getElementById('locateBtn').addEventListener('click', doLocate);
  document.getElementById('mapLocateFab').addEventListener('click', () => {
    if (userLat != null && userLng != null) {
      /* 이미 위치를 찾은 상태면 해당 위치로 다시 이동 */
      map.flyTo({ center: [userLng, userLat], zoom: 14, duration: 800 });
    } else {
      doLocate();
    }
  });

  /* Go to Seoul button */
  document.getElementById('goSeoulBtn').addEventListener('click', () => {
    map.flyTo({ center: [SEOUL.lng, SEOUL.lat], zoom: 11.5, duration: 1500 });
    document.getElementById('farBanner').style.display = 'none';
  });

  /* Radius buttons */
  document.querySelectorAll('.radius-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.radius-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentRadius = parseInt(btn.dataset.r);
      const zoomMap = { 1: 15, 3: 13.5, 5: 12.5, 10: 11.5 };
      map.easeTo({ zoom: zoomMap[currentRadius] || 13, duration: 500 });
      updateNearby();
    });
  });

  function updateNearby() {
    if (userLat == null) return;
    const nearbyList = document.getElementById('nearbyList');
    const nearby = LANDMARKS
      .map(lm => ({ ...lm, dist: haversine(userLat, userLng, lm.lat, lm.lng) }))
      .filter(lm => lm.dist <= currentRadius)
      .sort((a, b) => a.dist - b.dist);

    nearbyList.style.display = 'flex';
    if (nearby.length === 0) {
      nearbyList.innerHTML = `<div style="padding:20px;text-align:center;width:100%;color:var(--text-muted, var(--color-text-muted));font-size:0.85rem">${L.noResults}<br><small>${L.expandRadius}</small></div>`;
      return;
    }

    nearbyList.innerHTML = nearby.map(lm => `
      <a class="nearby-card" href="${lm.link || '#'}?lang=${lang}">
        ${lm.image ? `<img src="${lm.image}" alt="${pickLang(lm)}" onerror="this.style.background='var(--border, var(--color-border))';this.src='';" loading="lazy"/>` : '<div style="width:100%;height:90px;background:var(--border, var(--color-border))"></div>'}
        <div class="card-body">
          <div class="card-name">${pickLang(lm)}</div>
          <div class="card-dist">${formatDist(lm.dist)} ${L.away}</div>
        </div>
      </a>
    `).join('');
  }
})();
</script>
